<!DOCTYPE html>
<html lang="uz" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Anki Pro - macOS Style</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', '-apple-system', 'system-ui', 'sans-serif'] },
                    colors: {
                        ios: {
                            bg: '#000000',
                            surface: '#1c1c1e',
                            surface2: '#2c2c2e',
                            border: '#38383a',
                            blue: '#0a84ff',
                            green: '#30d158',
                            indigo: '#5e5ce6',
                            orange: '#ff9f0a',
                            red: '#ff453a',
                            text: '#ffffff',
                            subtext: '#8e8e93'
                        }
                    },
                    animation: {
                        'page-enter': 'pageEnter 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'page-exit': 'pageExit 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'card-flip': 'flip 0.6s cubic-bezier(0.4, 0.0, 0.2, 1)',
                        'scale-tap': 'scaleTap 0.1s ease-in-out',
                    },
                    keyframes: {
                        pageEnter: { '0%': { opacity: 0, transform: 'scale(0.98) translateY(10px)' }, '100%': { opacity: 1, transform: 'scale(1) translateY(0)' } },
                        pageExit: { '0%': { opacity: 1 }, '100%': { opacity: 0 } },
                        scaleTap: { '0%': { transform: 'scale(1)' }, '50%': { transform: 'scale(0.96)' }, '100%': { transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>

    <style>
        :root { --safe-area-top: env(safe-area-inset-top); --safe-area-bottom: env(safe-area-inset-bottom); }
        
        body {
            background-color: #000; color: #fff;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
            overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent;
        }

        .glass-panel {
            background: rgba(28, 28, 30, 0.75);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border-top: 0.5px solid rgba(255,255,255,0.12);
        }

        .card-scene { perspective: 1200px; width: 100%; height: 100%; }
        .card-object {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; -webkit-backface-visibility: hidden;
            border-radius: 24px; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
            background: #1c1c1e; border: 1px solid #38383a;
            box-shadow: 0 15px 40px -10px rgba(0,0,0,0.6);
            padding: 24px;
            word-break: break-word;
        }
        .card-front { transform: rotateY(0deg); }
        .card-back { transform: rotateY(180deg); background: #0a1e2e; }
        .is-flipped { transform: rotateY(180deg); }

        .ios-input {
            background: #2c2c2e; border: none; border-radius: 12px;
            padding: 16px; color: white; font-size: 17px; width: 100%;
            transition: all 0.3s; box-sizing: border-box; font-family: inherit;
        }
        .ios-input::placeholder { color: #8e8e93; }
        .ios-input:focus { outline: none; background: #3a3a3c; box-shadow: 0 0 0 2px #0a84ff; }
        
        .cloze-mask {
            background: rgba(10, 132, 255, 0.3); color: #0a84ff; border-radius: 6px;
            padding: 4px 10px; font-weight: 600; cursor: pointer; border: 1px solid #0a84ff;
            display: inline-block; margin: 0 2px;
        }
        .cloze-mask:hover { background: rgba(10, 132, 255, 0.5); }
        .cloze-reveal { color: #30d158; font-weight: 700; border-bottom: 2px solid #30d158; padding: 0 4px; }

        .tap-scale:active { transform: scale(0.96); opacity: 0.8; }
        .nav-active { color: #0a84ff !important; }
        .nav-active i { transform: scale(1.1); text-shadow: 0 0 15px rgba(10,132,255,0.5); }

        .heatmap-grid { display: grid; grid-template-columns: repeat(20, 1fr); gap: 4px; }
        .heat-cell { width: 100%; aspect-ratio: 1; border-radius: 3px; background: #2c2c2e; }
        .heat-1 { background: #004d1a; }
        .heat-2 { background: #00802b; }
        .heat-3 { background: #30d158; }

        .no-scrollbar { scrollbar-width: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        .study-question { 
            font-size: 24px; 
            line-height: 1.6; 
            font-weight: 500; 
            color: #ffffff;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .study-answer {
            font-size: 28px;
            line-height: 1.8;
            font-weight: 700;
            color: #30d158;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="flex flex-col h-[100dvh] w-full max-w-md mx-auto relative border-x border-ios-border bg-black shadow-2xl">

    <header class="h-14 flex items-center justify-between px-5 z-50 glass-panel absolute top-0 w-full rounded-b-2xl">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-ios-blue to-ios-indigo flex items-center justify-center text-white shadow-[0_0_15px_rgba(10,132,255,0.4)]">
                <i class="fa-brands fa-apple text-sm"></i>
            </div>
            <h1 class="text-[17px] font-semibold tracking-tight">Anki <span class="text-ios-blue">Pro</span></h1>
        </div>
        <button onclick="App.toggleLang()" class="w-8 h-8 rounded-full bg-ios-surface2 flex items-center justify-center text-[10px] font-bold text-ios-subtext tap-scale">
            <span id="lang-ind">UZ</span>
        </button>
    </header>

    <main id="viewport" class="flex-1 overflow-y-auto overflow-x-hidden pt-20 pb-28 px-4 relative scroll-smooth no-scrollbar">
        <!-- Content renders here -->
    </main>

    <nav class="h-[80px] w-full max-w-md fixed bottom-0 z-50 glass-panel flex justify-around items-center px-4 pb-4">
        <button onclick="Router.go('home')" id="nav-home" class="flex flex-col items-center gap-1 w-16 text-ios-subtext transition-all duration-300 tap-scale">
            <i class="fa-solid fa-layer-group text-xl mb-0.5"></i>
            <span class="text-[10px] font-medium" data-key="nav_home">Darslar</span>
        </button>
        
        <button onclick="Router.go('add')" id="nav-add" class="flex items-center justify-center w-14 h-14 bg-ios-blue text-white rounded-full shadow-[0_0_20px_rgba(10,132,255,0.4)] -mt-10 border-[5px] border-black tap-scale transition-transform hover:scale-105">
            <i class="fa-solid fa-plus text-xl"></i>
        </button>
        
        <button onclick="Router.go('stats')" id="nav-stats" class="flex flex-col items-center gap-1 w-16 text-ios-subtext transition-all duration-300 tap-scale">
            <i class="fa-solid fa-chart-pie text-xl mb-0.5"></i>
            <span class="text-[10px] font-medium" data-key="nav_stats">Tahlil</span>
        </button>
    </nav>

    <div id="modal-finish" class="fixed inset-0 z-[60] hidden flex-col items-center justify-center bg-black/90 backdrop-blur-md p-6 animate-page-enter overflow-y-auto">
        <div class="w-full max-w-sm">
            <div class="relative w-32 h-32 mx-auto mb-8">
                <svg class="w-full h-full transform -rotate-90">
                    <circle cx="64" cy="64" r="56" stroke="#2c2c2e" stroke-width="8" fill="none"></circle>
                    <circle cx="64" cy="64" r="56" stroke="#30d158" stroke-width="8" fill="none" stroke-dasharray="351" stroke-dashoffset="0" stroke-linecap="round"></circle>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center text-4xl">ðŸŽ‰</div>
            </div>

            <h2 class="text-2xl font-bold text-white mb-2 text-center" data-key="session_title">Ajoyib Natija!</h2>
            <p class="text-ios-subtext text-sm mb-8 text-center" data-key="session_sub">Bugungi reja to'liq bajarildi.</p>

            <div class="w-full bg-ios-surface border border-ios-border p-6 rounded-2xl relative overflow-hidden mb-8 shadow-2xl">
                <div class="absolute top-0 left-0 w-1.5 h-full bg-gradient-to-b from-ios-blue to-ios-indigo"></div>
                <i class="fa-solid fa-quote-left text-ios-surface2 text-4xl absolute top-4 right-4 opacity-20"></i>
                <p id="quote-text" class="text-lg font-medium text-white italic mb-4 relative z-10 font-serif leading-relaxed">...</p>
                <p id="quote-author" class="text-xs font-bold text-ios-blue uppercase tracking-widest text-right relative z-10">...</p>
            </div>

            <button onclick="Study.close()" class="w-full py-4 bg-ios-surface2 hover:bg-white hover:text-black text-white font-bold rounded-xl transition-all duration-300 tap-scale">
                <span data-key="btn_close">Yopish</span>
            </button>
        </div>
    </div>

    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-ios-surface2/90 backdrop-blur-md border border-ios-border text-white px-6 py-3 rounded-full shadow-2xl z-[70] flex items-center gap-3 opacity-0 pointer-events-none transition-all duration-300 transform scale-90">
        <i class="fa-solid fa-check-circle text-ios-green"></i>
        <span id="toast-msg" class="text-sm font-semibold">Saved</span>
    </div>

    <script>
        // ==========================================
        // 1. LOCALIZATION (TILLAR)
        // ==========================================
        const I18n = {
            uz: {
                nav_home: "Darslar",
                nav_stats: "Tahlil",
                hero_title: "Bugungi Vazifalar",
                hero_sub: "ta karta kutyapti",
                decks: "To'plamlar",
                no_decks: "To'plamlar yo'q. Yangi qo'shing.",
                add_h: "Yangi Yaratish",
                tab_card: "Karta",
                tab_deck: "To'plam",
                lbl_deck: "To'plamni tanlang",
                lbl_front: "Savol",
                lbl_back: "Javob",
                lbl_name: "To'plam Nomi",
                ph_front: "Savolni kiriting...",
                ph_back: "Javobni kiriting...",
                hint_cloze: "Format: {{c1::yashirin so'z}} yoki {{c2::yana bir so'z}}",
                btn_save: "Saqlash",
                btn_create: "Yaratish",
                study_h: "O'quv Jarayoni",
                study_left: "qoldi",
                show_ans: "Javobni Ko'rsatish",
                btn_again: "Qayta",
                btn_hard: "Qiyin",
                btn_good: "Yaxshi",
                btn_easy: "Oson",
                session_title: "Sessiya Yakunlandi!",
                session_sub: "Bilim darajangiz oshdi.",
                btn_close: "Bosh Sahifa",
                stats_h: "Statistika",
                strk: "Streak",
                xp: "Jami XP",
                total: "Kartalar",
                msg_saved: "Muvaffaqiyatli saqlandi!",
                msg_err: "Maydonlarni to'ldiring!",
                msg_deck_empty: "Bu to'plamda hech qanday karta yo'q!",
                msg_no_deck: "Avval to'plam yaratib oling!",
                cloze_hint: "{{c1::...}}, {{c2::...}} formatini ishlating"
            },
            en: {
                nav_home: "Library",
                nav_stats: "Stats",
                hero_title: "Today's Focus",
                hero_sub: "cards due",
                decks: "Decks",
                no_decks: "No decks found. Create one.",
                add_h: "Create New",
                tab_card: "Card",
                tab_deck: "Deck",
                lbl_deck: "Select Deck",
                lbl_front: "Question",
                lbl_back: "Answer",
                lbl_name: "Deck Name",
                ph_front: "Enter question...",
                ph_back: "Enter answer...",
                hint_cloze: "Format: {{c1::hidden word}} or {{c2::another word}}",
                btn_save: "Save Card",
                btn_create: "Create Deck",
                study_h: "Study Session",
                study_left: "left",
                show_ans: "Show Answer",
                btn_again: "Again",
                btn_hard: "Hard",
                btn_good: "Good",
                btn_easy: "Easy",
                session_title: "Session Complete!",
                session_sub: "Progress updated successfully.",
                btn_close: "Home",
                stats_h: "Analytics",
                strk: "Streak",
                xp: "Total XP",
                total: "Total Cards",
                msg_saved: "Saved Successfully!",
                msg_err: "Please fill all fields!",
                msg_deck_empty: "No cards in this deck!",
                msg_no_deck: "Create a deck first!",
                cloze_hint: "Use {{c1::...}}, {{c2::...}} format"
            }
        };

        const QUOTES = {
            uz: [
                { t: "Ilmdan o'zga najot yo'q va bo'lmagay.", a: "Imom Buxoriy" },
                { t: "Ozlarga hikmat - yomg'irdek, ko'plarga - seldek.", a: "Alisher Navoiy" },
                { t: "Vaqt - bu qilich. Agar sen uni kesmasang, u seni kesadi.", a: "Arab Hikmati" },
                { t: "Bugungi harakat - ertangi natija.", a: "Noma'lum" },
                { t: "O'qish - aql ziyosi.", a: "O'zbek Maqoli" }
            ],
            en: [
                { t: "Knowledge is power.", a: "Francis Bacon" },
                { t: "The roots of education are bitter, but the fruit is sweet.", a: "Aristotle" },
                { t: "Success is the sum of small efforts.", a: "Robert Collier" },
                { t: "An investment in knowledge pays the best interest.", a: "Benjamin Franklin" },
                { t: "Education is the most powerful weapon.", a: "Nelson Mandela" }
            ]
        };

        // ==========================================
        // 2. DATABASE (SAQLASH)
        // ==========================================
        const DB = {
            key: 'anki_pro_v6',
            state: {
                lang: 'uz',
                user: {
                    xp: 0,
                    streak: 0,
                    lastStudy: null,
                    heatmap: {}
                },
                decks: [],
                cards: []
            },

            init() {
                try {
                    const stored = localStorage.getItem(this.key);
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        this.state = { ...this.state, ...parsed };
                    } else {
                        this.seed();
                    }
                    this.syncStreak();
                } catch (e) {
                    console.error("DB init error:", e);
                    this.seed();
                }
            },

            save() {
                try {
                    localStorage.setItem(this.key, JSON.stringify(this.state));
                } catch (e) {
                    console.error("Save error:", e);
                }
            },

            seed() {
                const deckId = 'd_demo_' + Date.now();
                this.state.decks = [
                    {
                        id: deckId,
                        name: 'Ingliz tili (Demo)',
                        icon: 'fa-language',
                        color: 'from-blue-500 to-cyan-500'
                    }
                ];
                this.state.cards = [
                    {
                        id: 'c1',
                        deckId: deckId,
                        type: 'basic',
                        front: 'Apple',
                        back: 'Olma (meyva)',
                        interval: 0,
                        ease: 2.5,
                        due: Date.now(),
                        created: Date.now()
                    },
                    {
                        id: 'c2',
                        deckId: deckId,
                        type: 'cloze',
                        front: 'London is the capital of {{c1::United Kingdom}}.',
                        back: '',
                        interval: 0,
                        ease: 2.5,
                        due: Date.now(),
                        created: Date.now()
                    },
                    {
                        id: 'c3',
                        deckId: deckId,
                        type: 'basic',
                        front: 'What is 2 + 2?',
                        back: '4 (to'rt)',
                        interval: 0,
                        ease: 2.5,
                        due: Date.now(),
                        created: Date.now()
                    }
                ];
                this.save();
            },

            syncStreak() {
                const today = new Date().toISOString().split('T')[0];
                if (this.state.user.lastStudy && this.state.user.lastStudy !== today) {
                    const lastDate = new Date(this.state.user.lastStudy);
                    const currDate = new Date(today);
                    const diffMs = currDate.getTime() - lastDate.getTime();
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    
                    if (diffDays > 1) {
                        this.state.user.streak = 0;
                    }
                }
            }
        };

        // ==========================================
        // 3. ALGORITHM (FSRS LITE - SM2 HYBRID)
        // ==========================================
        const Brain = {
            calc(card, rating) {
                const now = Date.now();
                const dayMs = 86400000;
                let newInterval = 0;

                if (rating === 1) {
                    // AGAIN - Reset va ease kamaytirish
                    card.interval = 0;
                    card.ease = Math.max(1.3, card.ease - 0.2);
                    newInterval = 60000; // 1 minut
                } else {
                    // Good, Hard, Easy - Interval ortirish
                    if (card.interval === 0) {
                        card.interval = 1;
                    } else {
                        let multiplier = 1.2; // Default (Good)
                        if (rating === 2) multiplier = 0.8; // Hard
                        if (rating === 4) multiplier = 1.5; // Easy
                        
                        card.interval = Math.ceil(card.interval * card.ease * multiplier);
                    }
                    
                    // Ease o'zgarishi
                    if (rating === 4) card.ease += 0.15;
                    else if (rating === 2) card.ease -= 0.15;
                    
                    card.ease = Math.max(1.3, Math.min(2.5, card.ease));
                    
                    newInterval = card.interval * dayMs;
                }
                
                card.due = now + newInterval;
                return card;
            }
        };

        // ==========================================
        // 4. APP CONTROLLER (ASOSIY BOSHQARUV)
        // ==========================================
        const App = {
            lang: 'uz',
            
            init() {
                DB.init();
                this.lang = DB.state.lang;
                this.updateLangBtn();
                Router.go('home');
                this.translateAll();
            },

            toggleLang() {
                this.lang = this.lang === 'uz' ? 'en' : 'uz';
                DB.state.lang = this.lang;
                DB.save();
                this.updateLangBtn();
                this.translateAll();
                Router.refresh();
            },

            updateLangBtn() {
                const btn = document.getElementById('lang-ind');
                if (btn) btn.textContent = this.lang.toUpperCase();
            },

            t(key) {
                return (I18n[this.lang] && I18n[this.lang][key]) || key;
            },

            translateAll() {
                document.querySelectorAll('[data-key]').forEach(el => {
                    if (el) {
                        el.textContent = this.t(el.getAttribute('data-key'));
                    }
                });
            },

            toast(msg, type = 'success') {
                const toastEl = document.getElementById('toast');
                if (!toastEl) return;

                const msgEl = toastEl.querySelector('#toast-msg');
                const iconEl = toastEl.querySelector('i');
                
                if (msgEl) msgEl.textContent = msg;
                
                if (type === 'error') {
                    iconEl.className = 'fa-solid fa-triangle-exclamation text-ios-red';
                } else {
                    iconEl.className = 'fa-solid fa-check-circle text-ios-green';
                }

                toastEl.classList.remove('opacity-0', 'scale-90', 'pointer-events-none');
                toastEl.classList.add('opacity-100', 'scale-100', 'pointer-events-auto');
                
                setTimeout(() => {
                    toastEl.classList.add('opacity-0', 'scale-90', 'pointer-events-none');
                    toastEl.classList.remove('opacity-100', 'scale-100', 'pointer-events-auto');
                }, 2500);
            }
        };

        // ==========================================
        // 5. ROUTER (YO'NALISH)
        // ==========================================
        const Router = {
            current: 'home',
            params: null,
            
            go(view, params = null) {
                this.current = view;
                this.params = params;
                
                // Nav highlight
                ['home', 'add', 'stats'].forEach(v => {
                    const btn = document.getElementById('nav-' + v);
                    if (btn) {
                        if (v === view) {
                            btn.classList.add('nav-active', 'text-ios-blue');
                        } else {
                            btn.classList.remove('nav-active', 'text-ios-blue');
                        }
                    }
                });

                const viewport = document.getElementById('viewport');
                if (viewport) {
                    viewport.innerHTML = '';
                    
                    if (view === 'home') Views.home(viewport);
                    else if (view === 'add') Views.add(viewport);
                    else if (view === 'stats') Views.stats(viewport);
                    else if (view === 'study') Views.study(viewport);
                }

                App.translateAll();
            },

            refresh() {
                this.go(this.current, this.params);
            }
        };

        // ==========================================
        // 6. VIEWS (EKRANLAR)
        // ==========================================
        const Views = {
            home(el) {
                const totalDue = DB.state.cards.filter(c => c.due <= Date.now()).length;
                const user = DB.state.user;
                const level = Math.floor(user.xp / 100) + 1;
                
                let html = `
                    <div class="animate-page-enter space-y-6">
                        <!-- HERO CARD -->
                        <div class="w-full p-6 rounded-3xl bg-gradient-to-br from-ios-surface2 to-black border border-ios-border relative overflow-hidden shadow-2xl">
                            <div class="absolute -right-6 -top-6 w-32 h-32 bg-ios-blue blur-[60px] opacity-20"></div>
                            
                            <h2 class="text-xs font-bold text-ios-blue uppercase tracking-widest mb-1" data-key="hero_title">Bugungi Vazifalar</h2>
                            <div class="flex items-end gap-2 mb-4">
                                <span class="text-5xl font-bold text-white tracking-tighter">${totalDue}</span>
                                <span class="text-sm font-medium text-ios-subtext mb-2" data-key="hero_sub">ta karta kutyapti</span>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="flex gap-2 items-center">
                                <div class="h-1.5 flex-1 bg-ios-surface rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-ios-blue to-ios-green rounded-full transition-all duration-1000" style="width: ${Math.min(100, (user.xp % 100))}%"></div>
                                </div>
                                <span class="text-[10px] text-ios-subtext font-bold">Lvl ${level}</span>
                            </div>
                        </div>

                        <!-- DECKS SECTION -->
                        <div>
                            <h3 class="text-lg font-bold text-white mb-3 px-1" data-key="decks">To'plamlar</h3>
                            <div class="space-y-3">
                `;

                if (DB.state.decks.length === 0) {
                    html += `<div class="p-8 text-center border border-dashed border-ios-border rounded-2xl text-ios-subtext text-sm" data-key="no_decks">To'plamlar yo'q. Yangi qo'shing.</div>`;
                } else {
                    DB.state.decks.forEach(deck => {
                        const cardCount = DB.state.cards.filter(c => c.deckId === deck.id).length;
                        const dueCount = DB.state.cards.filter(c => c.deckId === deck.id && c.due <= Date.now()).length;

                        html += `
                            <div onclick="Study.init('${deck.id}')" class="group relative bg-ios-surface hover:bg-ios-surface2 border border-ios-border p-4 rounded-2xl flex items-center justify-between transition-all tap-scale shadow-sm cursor-pointer">
                                <div class="flex items-center gap-4 flex-1">
                                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br ${deck.color} flex items-center justify-center text-white text-xl shadow-lg flex-shrink-0">
                                        <i class="fa-solid ${deck.icon}"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <h4 class="font-bold text-white text-[17px] tracking-tight truncate">${deck.name}</h4>
                                        <p class="text-xs text-ios-subtext font-medium mt-0.5">${cardCount} Karta â€¢ <span class="${dueCount > 0 ? 'text-ios-green font-bold' : ''}">${dueCount} Due</span></p>
                                    </div>
                                </div>
                                <div class="w-8 h-8 rounded-full bg-black border border-ios-border flex items-center justify-center text-ios-subtext group-hover:text-white transition flex-shrink-0">
                                    <i class="fa-solid fa-chevron-right text-xs"></i>
                                </div>
                            </div>
                        `;
                    });
                }

                html += `</div></div></div>`;
                el.innerHTML = html;
            },

            add(el) {
                if (DB.state.decks.length === 0) {
                    el.innerHTML = `
                        <div class="animate-page-enter space-y-6">
                            <h2 class="text-2xl font-bold text-white px-1 tracking-tight" data-key="add_h">Yangi Yaratish</h2>
                            <div class="p-8 text-center border border-dashed border-ios-border rounded-2xl text-ios-subtext text-sm">
                                <p class="mb-4" data-key="msg_no_deck">Avval to'plam yaratib oling!</p>
                                <button onclick="UI.setAddMode('deck')" class="text-ios-blue font-bold">To'plam Yaratish</button>
                            </div>
                        </div>
                    `;
                    return;
                }

                const deckOptions = DB.state.decks.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
                
                el.innerHTML = `
                    <div class="animate-page-enter space-y-6">
                        <h2 class="text-2xl font-bold text-white px-1 tracking-tight" data-key="add_h">Yangi Yaratish</h2>
                        
                        <!-- MODE TOGGLE -->
                        <div class="grid grid-cols-2 gap-1 p-1 bg-ios-surface2 rounded-xl">
                            <button onclick="UI.setAddMode('card')" id="btn-mode-card" class="py-2 rounded-lg text-xs font-bold bg-ios-surface text-white shadow-sm transition" data-key="tab_card">Karta</button>
                            <button onclick="UI.setAddMode('deck')" id="btn-mode-deck" class="py-2 rounded-lg text-xs font-bold text-ios-subtext transition" data-key="tab_deck">To'plam</button>
                        </div>

                        <!-- CARD FORM -->
                        <div id="form-card" class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-ios-subtext uppercase ml-1 mb-2 block" data-key="lbl_deck">To'plamni tanlang</label>
                                <div class="relative">
                                    <select id="inp-deck" class="ios-input appearance-none">${deckOptions}</select>
                                    <i class="fa-solid fa-chevron-down absolute right-4 top-4 text-ios-subtext pointer-events-none text-sm"></i>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-ios-subtext uppercase ml-1 mb-2 block" data-key="lbl_front">Savol</label>
                                <textarea id="inp-front" rows="4" class="ios-input resize-none" placeholder="Savolni kiriting..."></textarea>
                                <p class="text-[10px] text-ios-blue mt-2 ml-1 opacity-80"><i class="fa-solid fa-lightbulb mr-1"></i> <span data-key="cloze_hint">{{c1::...}}, {{c2::...}} formatini ishlating</span></p>
                            </div>
                            <div id="back-wrap" class="block">
                                <label class="text-xs font-bold text-ios-subtext uppercase ml-1 mb-2 block" data-key="lbl_back">Javob</label>
                                <textarea id="inp-back" rows="3" class="ios-input resize-none" placeholder="Javobni kiriting..."></textarea>
                            </div>
                            <button onclick="Actions.saveCard()" class="w-full py-4 bg-ios-blue hover:bg-blue-600 text-white font-bold rounded-2xl shadow-[0_5px_15px_rgba(10,132,255,0.3)] tap-scale transition text-[17px]" data-key="btn_save">Saqlash</button>
                        </div>

                        <!-- DECK FORM -->
                        <div id="form-deck" class="space-y-4 hidden">
                            <div>
                                <label class="text-xs font-bold text-ios-subtext uppercase ml-1 mb-2 block" data-key="lbl_name">To'plam Nomi</label>
                                <input id="inp-deck-name" type="text" class="ios-input" placeholder="Nomni kiriting...">
                            </div>
                            <button onclick="Actions.saveDeck()" class="w-full py-4 bg-ios-surface2 border border-ios-border text-white font-bold rounded-2xl tap-scale transition" data-key="btn_create">Yaratish</button>
                        </div>
                    </div>
                `;
                App.translateAll();
            },

            stats(el) {
                const user = DB.state.user;
                const level = Math.floor(user.xp / 100) + 1;
                
                let grid = '';
                const today = new Date();
                
                for (let i = 0; i < 60; i++) {
                    const d = new Date();
                    d.setDate(today.getDate() - (59 - i));
                    const key = d.toISOString().split('T')[0];
                    const val = user.heatmap[key] || 0;
                    let cls = 'heat-cell';
                    if (val > 0) cls += ' heat-1';
                    if (val > 5) cls += ' heat-2';
                    if (val > 10) cls += ' heat-3';
                    grid += `<div class="${cls}" title="${key}: ${val} cards"></div>`;
                }

                el.innerHTML = `
                    <div class="animate-page-enter space-y-6">
                        <!-- TROPHY -->
                        <div class="w-24 h-24 rounded-full bg-ios-surface border-4 border-ios-blue mx-auto flex items-center justify-center shadow-2xl relative mt-4">
                            <i class="fa-solid fa-trophy text-4xl text-ios-orange"></i>
                            <div class="absolute -bottom-2 bg-ios-blue text-white text-[10px] font-bold px-3 py-1 rounded-full border-2 border-black">
                                LVL ${level}
                            </div>
                        </div>

                        <h2 class="text-2xl font-bold text-white text-center" data-key="stats_h">Statistika</h2>

                        <!-- STATS GRID -->
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-ios-surface p-4 rounded-2xl border border-ios-border">
                                <div class="text-center">
                                    <i class="fa-solid fa-fire text-ios-orange text-2xl mb-2 block"></i>
                                    <div class="text-3xl font-bold text-white">${user.streak}</div>
                                    <div class="text-[10px] font-bold text-ios-subtext uppercase mt-1" data-key="strk">Streak</div>
                                </div>
                            </div>
                            <div class="bg-ios-surface p-4 rounded-2xl border border-ios-border">
                                <div class="text-center">
                                    <i class="fa-solid fa-bolt text-ios-green text-2xl mb-2 block"></i>
                                    <div class="text-3xl font-bold text-white">${user.xp}</div>
                                    <div class="text-[10px] font-bold text-ios-subtext uppercase mt-1" data-key="xp">Jami XP</div>
                                </div>
                            </div>
                        </div>

                        <!-- HEATMAP -->
                        <div class="bg-ios-surface p-4 rounded-2xl border border-ios-border">
                            <h3 class="text-sm font-bold text-white mb-3">60 kun o'quv xarxasi</h3>
                            <div class="heatmap-grid">${grid}</div>
                        </div>

                        <!-- CARD COUNT -->
                        <div class="bg-ios-surface p-4 rounded-2xl border border-ios-border">
                            <div class="flex items-center justify-between">
                                <span class="text-ios-subtext" data-key="total">Kartalar</span>
                                <span class="text-2xl font-bold text-ios-blue">${DB.state.cards.length}</span>
                            </div>
                        </div>
                    </div>
                `;
                App.translateAll();
            },

            study(el) {
                el.innerHTML = `<div id="study-area" class="h-full flex flex-col relative"></div>`;
            }
        };

        // ==========================================
        // 7. UI & ACTIONS (TUGMALAR VA AMALLAR)
        // ==========================================
        const UI = {
            setAddMode(mode) {
                const isCard = mode === 'card';
                const cardForm = document.getElementById('form-card');
                const deckForm = document.getElementById('form-deck');
                const btnCard = document.getElementById('btn-mode-card');
                const btnDeck = document.getElementById('btn-mode-deck');

                if (cardForm) cardForm.classList.toggle('hidden', !isCard);
                if (deckForm) deckForm.classList.toggle('hidden', isCard);

                if (btnCard) {
                    btnCard.className = isCard 
                        ? "py-2 rounded-lg text-xs font-bold bg-ios-surface text-white shadow-sm transition" 
                        : "py-2 rounded-lg text-xs font-bold text-ios-subtext transition";
                }
                if (btnDeck) {
                    btnDeck.className = !isCard 
                        ? "py-2 rounded-lg text-xs font-bold bg-ios-surface text-white shadow-sm transition" 
                        : "py-2 rounded-lg text-xs font-bold text-ios-subtext transition";
                }
            }
        };

        const Actions = {
            saveDeck() {
                const nameInput = document.getElementById('inp-deck-name');
                const name = nameInput ? nameInput.value.trim() : '';

                if (!name) {
                    App.toast(App.t('msg_err'), 'error');
                    return;
                }

                const colors = [
                    'from-blue-500 to-indigo-500',
                    'from-red-500 to-orange-500',
                    'from-green-500 to-emerald-500',
                    'from-purple-500 to-pink-500',
                    'from-cyan-500 to-blue-500'
                ];
                const icons = ['fa-book', 'fa-code', 'fa-atom', 'fa-globe', 'fa-language', 'fa-star'];

                DB.state.decks.push({
                    id: 'd_' + Date.now(),
                    name: name,
                    icon: icons[Math.floor(Math.random() * icons.length)],
                    color: colors[Math.floor(Math.random() * colors.length)]
                });

                DB.save();
                UI.setAddMode('card');
                if (nameInput) nameInput.value = '';
                App.toast(App.t('msg_saved'));
                setTimeout(() => Router.go('home'), 500);
            },

            saveCard() {
                const deckSelect = document.getElementById('inp-deck');
                const frontInput = document.getElementById('inp-front');
                const backInput = document.getElementById('inp-back');

                const deckId = deckSelect ? deckSelect.value : null;
                const front = frontInput ? frontInput.value.trim() : '';
                const back = backInput ? backInput.value.trim() : '';

                if (!front || !deckId) {
                    App.toast(App.t('msg_err'), 'error');
                    return;
                }

                let type = 'basic';
                if (front.includes('{{c1::') && front.includes('}}')) {
                    type = 'cloze';
                }

                DB.state.cards.push({
                    id: 'c_' + Date.now(),
                    deckId: deckId,
                    type: type,
                    front: front,
                    back: type === 'cloze' ? '' : back,
                    interval: 0,
                    ease: 2.5,
                    due: Date.now(),
                    created: Date.now()
                });

                DB.save();
                if (frontInput) frontInput.value = '';
                if (backInput) backInput.value = '';
                App.toast(App.t('msg_saved'));
            }
        };

        // ==========================================
        // 8. STUDY ENGINE (O'QUISH JARAYONI)
        // ==========================================
        const Study = {
            queue: [],
            current: null,
            flipped: false,
            startTime: null,

            init(deckId) {
                this.queue = DB.state.cards
                    .filter(c => c.deckId === deckId && c.due <= Date.now())
                    .sort((a, b) => a.due - b.due);

                if (this.queue.length === 0) {
                    App.toast(App.t('msg_deck_empty'), 'error');
                    return;
                }

                this.startTime = Date.now();
                Router.go('study');
                this.next();
            },

            next() {
                if (this.queue.length === 0) {
                    this.finish();
                    return;
                }

                this.current = this.queue[0];
                this.flipped = false;
                this.renderCard();
            },

            renderCard() {
                const card = this.current;
                const area = document.getElementById('study-area');
                
                if (!area || !card) return;

                let front = card.front;
                let back = card.back;

                // CLOZE processing
                if (card.type === 'cloze') {
                    front = front.replace(/\{\{c\d+::(.*?)\}\}/g, '<span class="cloze-mask">...</span>');
                    back = card.front.replace(/\{\{c\d+::(.*?)\}\}/g, '<span class="cloze-reveal">$1</span>');
                }

                area.innerHTML = `
                    <div class="flex items-center justify-between mb-6 animate-page-enter">
                        <button onclick="Router.go('home')" class="w-8 h-8 rounded-full bg-ios-surface text-ios-subtext hover:text-white transition tap-scale">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                        <div class="px-3 py-1 bg-ios-surface rounded-full border border-ios-border text-[10px] font-bold text-ios-blue uppercase tracking-wider">
                            ${this.queue.length} <span data-key="study_left">qoldi</span>
                        </div>
                        <div class="w-8"></div>
                    </div>

                    <!-- 3D CARD CONTAINER -->
                    <div class="flex-1 card-scene mb-8 cursor-pointer animate-page-enter" onclick="Study.flip()">
                        <div id="active-card" class="card-object">
                            <!-- QUESTION SIDE -->
                            <div class="card-face card-front">
                                <div class="text-[11px] font-bold text-ios-subtext uppercase tracking-widest mb-6">Savol</div>
                                <div class="study-question">${front}</div>
                                <div class="absolute bottom-8 text-[11px] text-ios-blue opacity-60 animate-pulse" data-key="show_ans">Javobni Ko'rsatish</div>
                            </div>
                            <!-- ANSWER SIDE -->
                            <div class="card-face card-back">
                                <div class="text-[11px] font-bold text-ios-subtext uppercase tracking-widest mb-6">Javob</div>
                                <div class="study-answer">${back}</div>
                            </div>
                        </div>
                    </div>

                    <!-- CONTROLS -->
                    <div class="flex flex-col gap-3 pb-4">
                        <button id="btn-show" onclick="Study.flip()" class="w-full py-4 bg-ios-blue hover:bg-blue-600 text-white font-bold rounded-2xl shadow-[0_5px_15px_rgba(10,132,255,0.3)] tap-scale transition text-[17px]" data-key="show_ans">
                            Javobni Ko'rsatish
                        </button>

                        <div id="grading-grid" class="hidden grid grid-cols-4 gap-2">
                            <button onclick="Study.rate(1)" class="py-3 px-2 bg-ios-red/20 border border-ios-red text-ios-red rounded-xl font-bold text-xs active:bg-ios-red/40 transition flex flex-col items-center justify-center">
                                <i class="fa-solid fa-arrow-rotate-left text-lg mb-1"></i>
                                <span data-key="btn_again">Qayta</span>
                                <span class="text-[9px] opacity-70 mt-0.5">1m</span>
                            </button>
                            <button onclick="Study.rate(2)" class="py-3 px-2 bg-ios-orange/20 border border-ios-orange text-ios-orange rounded-xl font-bold text-xs active:bg-ios-orange/40 transition flex flex-col items-center justify-center">
                                <i class="fa-solid fa-hourglass-end text-lg mb-1"></i>
                                <span data-key="btn_hard">Qiyin</span>
                                <span class="text-[9px] opacity-70 mt-0.5">10m</span>
                            </button>
                            <button onclick="Study.rate(3)" class="py-3 px-2 bg-ios-green/20 border border-ios-green text-ios-green rounded-xl font-bold text-xs active:bg-ios-green/40 transition flex flex-col items-center justify-center">
                                <i class="fa-solid fa-check text-lg mb-1"></i>
                                <span data-key="btn_good">Yaxshi</span>
                                <span class="text-[9px] opacity-70 mt-0.5">1d</span>
                            </button>
                            <button onclick="Study.rate(4)" class="py-3 px-2 bg-ios-blue/20 border border-ios-blue text-ios-blue rounded-xl font-bold text-xs active:bg-ios-blue/40 transition flex flex-col items-center justify-center">
                                <i class="fa-solid fa-star text-lg mb-1"></i>
                                <span data-key="btn_easy">Oson</span>
                                <span class="text-[9px] opacity-70 mt-0.5">4d</span>
                            </button>
                        </div>
                    </div>
                `;
                App.translateAll();
            },

            flip() {
                if (this.flipped) return;
                
                this.flipped = true;
                const card = document.getElementById('active-card');
                const btnShow = document.getElementById('btn-show');
                const gridding = document.getElementById('grading-grid');

                if (card) card.classList.add('is-flipped');
                if (btnShow) btnShow.classList.add('hidden');
                if (gridding) {
                    gridding.classList.remove('hidden');
                    gridding.classList.add('grid');
                }
            },

            rate(rating) {
                // Algorithm hisoblash
                const updated = Brain.calc(this.current, rating);
                
                // DB da yangilash
                const idx = DB.state.cards.findIndex(c => c.id === updated.id);
                if (idx >= 0) {
                    DB.state.cards[idx] = updated;
                }

                // XP qo'shish
                DB.state.user.xp += rating * 2;

                // Heatmap yangilash
                const today = new Date().toISOString().split('T')[0];
                if (!DB.state.user.heatmap[today]) {
                    DB.state.user.heatmap[today] = 0;
                }
                DB.state.user.heatmap[today]++;

                // Streak yangilash
                if (DB.state.user.lastStudy !== today) {
                    DB.state.user.streak++;
                    DB.state.user.lastStudy = today;
                }

                DB.save();

                // Queue boshqarish
                this.queue.shift();
                if (rating === 1) {
                    // Again bo'lsa, oxiriga qo'shish
                    this.queue.push(updated);
                }

                // Keyingi karta
                this.next();
            },

            finish() {
                // Confetti effekti
                confetti({
                    particleCount: 100,
                    spread: 60,
                    origin: { y: 0.6 },
                    colors: ['#0a84ff', '#30d158', '#ff9f0a', '#ff453a']
                });

                // Quotes ko'rsatish
                const allQuotes = QUOTES[App.lang] || [];
                if (allQuotes.length > 0) {
                    const randomQuote = allQuotes[Math.floor(Math.random() * allQuotes.length)];
                    const quoteText = document.getElementById('quote-text');
                    const quoteAuthor = document.getElementById('quote-author');
                    
                    if (quoteText) quoteText.textContent = '"' + randomQuote.t + '"';
                    if (quoteAuthor) quoteAuthor.textContent = randomQuote.a;
                }

                // Modalni ko'rsatish
                const modal = document.getElementById('modal-finish');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }
            },

            close() {
                const modal = document.getElementById('modal-finish');
                if (modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
                Router.go('home');
            }
        };

        // ==========================================
        // 9. INITIALIZATION (BOSHLASH)
        // ==========================================
        window.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>
</html>
