<!DOCTYPE html>
<html lang="uz" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ilm Nuri - Ultra Smart Anki</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: {
                        brand: {
                            bg: '#0F172A', // Slate 900
                            card: '#1E293B', // Slate 800
                            primary: '#3B82F6', // Blue 500
                            secondary: '#6366F1', // Indigo 500
                            accent: '#10B981', // Emerald 500
                            gold: '#F59E0B', // Amber 500
                            error: '#EF4444' // Red 500
                        }
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'slide-up': 'slideUp 0.4s ease-out forwards'
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-5px)' } },
                        pop: { '0%': { opacity: 0, transform: 'scale(0.8)' }, '100%': { opacity: 1, transform: 'scale(1)' } },
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* Global Reset & Mobile View */
        body { background-color: #0F172A; color: #F8FAFC; -webkit-tap-highlight-color: transparent; overflow-x: hidden; overflow-y: auto; }
        
        /* Ensure main app container is centered and uses full height */
        .app-container { height: 100dvh; max-width: 480px; margin-left: auto; margin-right: auto; }

        /* Custom Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Card Flip 3D */
        .perspective-1000 { perspective: 1000px; }
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1); transform-style: preserve-3d; }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 1.5rem; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 2rem; background: #1E293B; border: 1px solid #334155; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5); }
        .card-back { transform: rotateY(180deg); background: #1E293B; position: relative; }
        .flipped { transform: rotateY(180deg); }

        /* Inputs */
        .modern-input { background: #334155; border: 2px solid transparent; color: white; padding: 1rem; border-radius: 1rem; width: 100%; transition: all 0.3s; font-size: 1.1rem; }
        .modern-input:focus { border-color: #3B82F6; outline: none; background: #1E293B; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2); }

        /* Cloze Styles */
        .cloze-hidden { background: #3B82F6; color: transparent; border-radius: 6px; padding: 2px 8px; font-weight: bold; cursor: help; }
        .cloze-revealed { color: #60A5FA; font-weight: bold; border-bottom: 2px solid #3B82F6; }

        /* Motivatsiya Modali */
        .glass-overlay { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); }
    </style>
</head>
<body class="flex flex-col h-[100dvh] w-full app-container relative border-x border-slate-800 shadow-2xl">

    <!-- HEADER (Navigation) -->
    <header class="h-16 flex items-center justify-between px-6 bg-brand-bg/90 backdrop-blur-md z-20 border-b border-slate-800 sticky top-0">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-brand-primary to-brand-secondary flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
                <i class="fa-solid fa-brain text-lg animate-pulse"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-none">Ilm Nuri</h1>
                <p class="text-xs text-slate-400 font-medium mt-1">Smart Ta'lim Tizimi</p>
            </div>
        </div>
        <div class="flex flex-col items-end">
            <span class="text-xs text-slate-400 font-bold uppercase">Streak</span>
            <span class="text-brand-gold font-bold flex items-center gap-1"><i class="fa-solid fa-fire"></i> <span id="streak-display">0</span></span>
        </div>
    </header>

    <!-- ASOSIY OYNA (VIEWPORT) -->
    <main id="app-viewport" class="flex-1 overflow-y-auto overflow-x-hidden p-5 pb-24 relative no-scrollbar bg-brand-bg">
        <!-- JS orqali to'ldiriladi -->
    </main>

    <!-- PASTKI MENU (Ergonomik) -->
    <nav class="fixed bottom-0 w-full max-w-md bg-brand-card/95 backdrop-blur-lg border-t border-slate-700 h-20 z-30 flex justify-around items-center px-2 pb-2 shadow-2xl app-container mx-auto">
        <button onclick="Router.nav('decks')" id="nav-decks" class="flex flex-col items-center justify-center w-16 h-16 rounded-2xl text-slate-400 transition hover:text-white active:scale-95 gap-1">
            <i class="fa-solid fa-layer-group text-xl"></i>
            <span class="text-[10px] font-bold">Darslar</span>
        </button>

        <button onclick="Router.nav('add')" id="nav-add" class="flex items-center justify-center w-14 h-14 bg-brand-primary text-white rounded-full shadow-lg shadow-blue-500/40 -mt-8 border-4 border-brand-bg active:scale-90 transition transform hover:rotate-90">
            <i class="fa-solid fa-plus text-2xl"></i>
        </button>

        <button onclick="Router.nav('profile')" id="nav-profile" class="flex flex-col items-center justify-center w-16 h-16 rounded-2xl text-slate-400 transition hover:text-white active:scale-95 gap-1">
            <i class="fa-solid fa-chart-pie text-xl"></i>
            <span class="text-[10px] font-bold">Natijalar</span>
        </button>
    </nav>

    <!-- MOTIVATION MODAL (Overlay) -->
    <div id="motivation-modal" class="fixed inset-0 glass-overlay z-50 hidden flex flex-col items-center justify-center p-6 text-center animate-pop app-container mx-auto">
        <div class="w-20 h-20 rounded-full bg-brand-card border-2 border-brand-gold flex items-center justify-center text-4xl mb-6 shadow-2xl animate-float">
            üí°
        </div>
        <h2 id="quote-author" class="text-brand-primary text-sm font-bold uppercase tracking-widest mb-3"></h2>
        <p id="quote-text" class="text-xl md:text-2xl font-bold text-white leading-relaxed mb-8 italic">
            "..."
        </p>
        <button onclick="Motivation.close()" class="w-full py-4 bg-white text-brand-bg font-extrabold rounded-2xl text-lg shadow-xl active:scale-95 transition">
            Davom Etish <i class="fa-solid fa-arrow-right ml-2"></i>
        </button>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 bg-brand-card border border-slate-700 text-white px-6 py-3 rounded-full shadow-2xl z-50 flex items-center gap-3 transition-all duration-300 opacity-0 pointer-events-none transform translate-y-[-20px]">
        <i class="fa-solid text-brand-accent" id="toast-icon"></i>
        <span id="toast-msg" class="text-sm font-bold"></span>
    </div>

    <script>
        /**
         * "ILM NURI" ULTRA ENGINE (FIXED V2)
         * - Ma'lumotlarni saqlash xatolari tuzatildi.
         * - Ergonimik dizayn yaxshilandi.
         * - Motivatsiya tizimi har doim ishlaydigan qilindi.
         */

        // --- 1. MA'LUMOTLAR BAZASI (ROBUST & RESILIENT) ---
        const DB = {
            key: 'ilm_nuri_data_v2', // Versiya o'zgartirildi
            data: {
                user: { xp: 0, streak: 0, lastStudy: null },
                decks: [],
                cards: []
            },

            init() {
                try {
                    const loaded = localStorage.getItem(this.key);
                    if (loaded) {
                        this.data = JSON.parse(loaded);
                        console.log("DB Loaded successfully.");
                        // Ma'lumotlar strukturasini tekshirish
                        if (!this.data.decks || !Array.isArray(this.data.decks)) {
                             throw new Error("Invalid DB structure, resetting.");
                        }
                    } else {
                        this.data = this.seed();
                        console.log("DB Initialized with seed data.");
                    }
                } catch (e) {
                    console.error("DB Load Error:", e);
                    this.data = this.seed();
                    this.save();
                }
                this.checkStreak();
            },

            save() {
                try {
                    localStorage.setItem(this.key, JSON.stringify(this.data));
                } catch (e) {
                    console.error("Failed to save to localStorage:", e);
                    UI.toast("Ma'lumotlarni saqlashda xato yuz berdi!", "error");
                }
            },

            seed() {
                return {
                    user: { xp: 0, streak: 0, lastStudy: null },
                    decks: [
                        { id: 'd1', name: 'Ingliz Tili So\'zlari', icon: 'fa-language', color: 'from-blue-600 to-cyan-500' },
                        { id: 'd2', name: 'Dasturlash Asoslari', icon: 'fa-code', color: 'from-purple-600 to-indigo-600' }
                    ],
                    cards: [
                        { id: 'c1', deckId: 'd1', front: 'Knowledge', back: 'Ilm / Bilim', type: 'basic', nextReview: Date.now(), interval: 0, ease: 2.5 },
                        { id: 'c2', deckId: 'd2', front: 'JavaScriptda o\'zgaruvchi {{c1::let}} yoki {{c1::const}} orqali e\'lon qilinadi.', back: '', type: 'cloze', nextReview: Date.now(), interval: 0, ease: 2.5 }
                    ]
                };
            },

            checkStreak() {
                const today = new Date().toDateString();
                if (this.data.user.lastStudy && this.data.user.lastStudy !== today) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    if (this.data.user.lastStudy !== yesterday.toDateString()) {
                        this.data.user.streak = 0; // Streak uzildi
                    }
                }
                document.getElementById('streak-display').innerText = this.data.user.streak;
            }
        };

        // --- 2. HIKMATLAR XAZINASI (MOTIVATION ENGINE) ---
        const Motivation = {
            quotes: [
                { author: "Alisher Navoiy", text: "Kamoli insondir ahli ilmni, ilm ahlini qilg'il doimo ahli-ilm." },
                { author: "Imom Buxoriy", text: "Ilmdan boshqa najot yo'q va bo'lmagay." },
                { author: "Abu Rayhon Beruniy", text: "Bilim va ilm - insoniyatning eng buyuk yutug'idir." },
                { author: "Abdulla Avloniy", text: "Tarbiya biz uchun yo hayot - yo mamot, yo najot - yo halokat, yo saodat - yo falokat masalasidir." },
                { author: "Hadis", text: "Beshikdan qabrgacha ilm izlang." },
                { author: "Ahmad Yassaviy", text: "Ilm o'rganding, oxir uni unutma, nafsingni sindir, g'aflatda qolma." },
                { author: "Motivatsiya", text: "Xato qilish - o'rganishning bir qismidir. Har bir xato - yangi bilimga qadamdir. To'xtamang!" },
                { author: "Albert Eynshteyn", text: "Men aqlli emasman, shunchaki muammolar ustida uzoqroq turaman." }
            ],

            show() {
                const modal = document.getElementById('motivation-modal');
                const random = this.quotes[Math.floor(Math.random() * this.quotes.length)];
                
                document.getElementById('quote-author').innerText = random.author;
                document.getElementById('quote-text').innerText = `"${random.text}"`;
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            },

            close() {
                const modal = document.getElementById('motivation-modal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                
                // Quote yopilgandan keyin keyingi kartaga o'tish
                Study.nextCard();
            }
        };

        // --- 3. ALGORITM (SM-2 SIMPLIFIED & ROBUST) ---
        const Algorithm = {
            // Ratings: 1 (Qayta), 2 (Qiyin), 3 (Yaxshi), 4 (Oson)
            calculate(card, rating) {
                const now = Date.now();
                const minute = 60 * 1000;
                const day = 24 * 60 * 60 * 1000;

                let nextTimeAdd = 0;
                let intervalDays = 0;

                if (rating === 1) { // Qayta (Again)
                    card.interval = 0;
                    card.ease = Math.max(1.3, card.ease - 0.2);
                    intervalDays = 0.0035; // ~5 minut
                } else if (rating === 2) { // Qiyin (Hard)
                    card.interval = 0.007; // ~10 minut
                    card.ease = Math.max(1.3, card.ease - 0.15);
                    intervalDays = card.interval; 
                } else if (rating === 3) { // Yaxshi (Good)
                    if (card.interval === 0) intervalDays = 1; // 1 kun
                    else intervalDays = Math.round(card.interval * card.ease);
                    card.interval = intervalDays;
                } else { // Oson (Easy)
                    if (card.interval === 0) intervalDays = 3; // 3 kun
                    else intervalDays = Math.round(card.interval * card.ease * 1.3);
                    card.ease += 0.15;
                    card.interval = intervalDays;
                }
                
                // Ensure interval is a minimum of 1 minute if it was rated poorly
                if (intervalDays < 0.01) {
                    nextTimeAdd = intervalDays * day * 2; // 5-10 minut atrofida
                } else {
                    nextTimeAdd = intervalDays * day;
                }

                card.nextReview = now + nextTimeAdd;
                return card;
            }
        };

        // --- 4. NAVIGATION & VIEWS ---
        const Router = {
            current: 'decks',
            
            nav(page, param = null) {
                this.current = page;
                const vp = document.getElementById('app-viewport');
                
                // Active Nav Styling
                ['decks', 'add', 'profile'].forEach(id => {
                    const el = document.getElementById('nav-'+id);
                    if(el) {
                        if(id === page) {
                            el.classList.add('text-brand-primary'); 
                            el.classList.remove('text-slate-400');
                        } else {
                            el.classList.remove('text-brand-primary');
                            el.classList.add('text-slate-400');
                        }
                    }
                });

                vp.innerHTML = ''; // Tozalash

                if (page === 'decks') this.renderDecks(vp);
                else if (page === 'add') this.renderAdd(vp);
                else if (page === 'profile') this.renderProfile(vp);
                else if (page === 'study') this.renderStudy(vp, param);
            },

            renderDecks(container) {
                const decks = DB.data.decks;
                // Kartalar sonini hisoblash
                const dueCardsCount = DB.data.cards.filter(c => c.nextReview <= Date.now()).length;
                
                let html = `
                    <div class="space-y-6 animate-slide-up">
                        <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-3xl border border-slate-700 relative overflow-hidden">
                            <div class="absolute right-0 top-0 w-32 h-32 bg-brand-primary blur-[80px] opacity-20"></div>
                            <h2 class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Bugungi Maqsad</h2>
                            <div class="flex items-baseline gap-2">
                                <span class="text-4xl font-extrabold text-white">${dueCardsCount}</span>
                                <span class="text-sm font-medium text-slate-400">ta karta takrorlash kerak</span>
                            </div>
                        </div>
                        
                        <h3 class="font-bold text-lg text-white px-1">To'plamlarim</h3>
                        <div class="space-y-3">
                `;

                if(decks.length === 0) {
                    html += `<div class="text-center py-10 text-slate-500">To'plamlar yo'q. "+" tugmasini bosing!</div>`;
                }

                decks.forEach(deck => {
                    const dueCount = DB.data.cards.filter(c => c.deckId === deck.id && c.nextReview <= Date.now()).length;
                    const total = DB.data.cards.filter(c => c.deckId === deck.id).length;

                    html += `
                        <div onclick="Study.start('${deck.id}')" class="bg-brand-card hover:bg-slate-700 border border-slate-700 p-4 rounded-2xl flex items-center justify-between transition-transform active:scale-[0.98] shadow-lg">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br ${deck.color} flex items-center justify-center text-white text-xl shadow-lg">
                                    <i class="fa-solid ${deck.icon}"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-white text-base">${deck.name}</h4>
                                    <p class="text-xs text-slate-400 font-medium mt-1">${total} ta karta ‚Ä¢ <span class="${dueCount > 0 ? 'text-brand-accent' : ''}">${dueCount} ta faol</span></p>
                                </div>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-slate-900 flex items-center justify-center text-slate-500">
                                <i class="fa-solid fa-chevron-right ml-0.5"></i>
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;
                container.innerHTML = html;
            },

            renderAdd(container) {
                const decks = DB.data.decks;
                const options = decks.map(d => `<option value="${d.id}">${d.name}</option>`).join('');

                container.innerHTML = `
                    <div class="animate-slide-up space-y-6">
                        <h2 class="text-2xl font-bold text-white px-1">Yangi Ilm Qo'shish</h2>
                        
                        <div class="flex bg-slate-800 p-1 rounded-xl">
                            <button onclick="UI.toggleType('basic')" id="btn-basic" class="flex-1 py-3 rounded-xl bg-brand-primary text-white font-bold text-sm shadow-lg transition">Savol-Javob</button>
                            <button onclick="UI.toggleType('cloze')" id="btn-cloze" class="flex-1 py-3 rounded-xl text-slate-400 font-bold text-sm hover:text-white transition">Bo'shliqni To'ldirish</button>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-400 ml-1 uppercase">Mavzu (To'plam)</label>
                                <select id="inp-deck" class="modern-input mt-2 cursor-pointer bg-slate-800">
                                    ${options}
                                </select>
                            </div>

                            <div>
                                <label class="text-xs font-bold text-slate-400 ml-1 uppercase">Savol (Front)</label>
                                <textarea id="inp-front" rows="3" class="modern-input mt-2" placeholder="Savolni kiriting..."></textarea>
                                <p id="cloze-hint" class="hidden text-xs text-brand-primary mt-2 bg-blue-900/30 p-2 rounded border border-blue-900">
                                    <i class="fa-solid fa-circle-info mr-1"></i> Format: {{c1::yashirin so'z}} (Bu yerdagi so'zlar javob bo'ladi)
                                </p>
                            </div>

                            <div id="back-box">
                                <label class="text-xs font-bold text-slate-400 ml-1 uppercase">Javob (Back)</label>
                                <textarea id="inp-back" rows="3" class="modern-input mt-2" placeholder="Javobni kiriting..."></textarea>
                            </div>

                            <button onclick="Actions.addCard()" class="w-full py-4 bg-brand-primary hover:bg-blue-600 text-white font-bold rounded-2xl shadow-lg shadow-blue-500/20 active:scale-[0.98] transition mt-4 text-lg">
                                <i class="fa-solid fa-save mr-2"></i> Saqlash
                            </button>

                            <div class="border-t border-slate-700 pt-6 mt-6">
                                <h3 class="text-sm font-bold text-white mb-3">Yangi To'plam Yaratish</h3>
                                <div class="flex gap-2">
                                    <input id="inp-deck-name" type="text" class="modern-input py-3 text-sm" placeholder="To'plam nomi...">
                                    <button onclick="Actions.addDeck()" class="px-6 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded-xl transition">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                UI.toggleType(UI.currentType); // Viewni to'g'ri tiklash
            },

            renderProfile(container) {
                container.innerHTML = `
                    <div class="animate-slide-up flex flex-col items-center justify-center h-[70vh] text-center space-y-6">
                        <div class="w-32 h-32 rounded-full bg-slate-800 border-4 border-brand-primary flex items-center justify-center shadow-2xl relative">
                            <i class="fa-solid fa-trophy text-5xl text-brand-gold animate-float"></i>
                            <div class="absolute bottom-0 right-0 bg-brand-primary text-white text-xs font-bold px-3 py-1 rounded-full border-2 border-slate-900">
                                LEVEL ${Math.floor(DB.data.user.xp / 100) + 1}
                            </div>
                        </div>
                        
                        <div>
                            <h2 class="text-3xl font-bold text-white">Natijalar</h2>
                            <p class="text-slate-400 font-medium">Sizning bilim darajangiz</p>
                        </div>

                        <div class="grid grid-cols-2 gap-4 w-full">
                            <div class="bg-slate-800 p-4 rounded-2xl border border-slate-700">
                                <p class="text-brand-gold text-2xl font-bold">${DB.data.user.streak}</p>
                                <p class="text-xs text-slate-400 uppercase font-bold">Kunlik Streak</p>
                            </div>
                            <div class="bg-slate-800 p-4 rounded-2xl border border-slate-700">
                                <p class="text-brand-primary text-2xl font-bold">${DB.data.user.xp}</p>
                                <p class="text-xs text-slate-400 uppercase font-bold">Umumiy XP</p>
                            </div>
                        </div>

                        <button onclick="Actions.reset()" class="text-brand-error text-xs font-bold opacity-50 mt-10 hover:opacity-100 transition">Barcha ma'lumotlarni o'chirish (Diqqat!)</button>
                    </div>
                `;
            },

            renderStudy(container, deckId) {
                container.innerHTML = `<div id="study-container" class="h-full flex flex-col relative"></div>`;
            }
        };

        // --- 5. STUDY LOGIC (CORE) ---
        const Study = {
            queue: [],
            currentCard: null,
            deckId: null,
            isFlipped: false,

            start(deckId) {
                this.deckId = deckId;
                // Faqat vaqti kelgan kartalar
                this.queue = DB.data.cards
                    .filter(c => c.deckId === deckId && c.nextReview <= Date.now())
                    .sort((a,b) => a.nextReview - b.nextReview);

                if (this.queue.length === 0) {
                    UI.toast("Bugungi darslar tugadi! üéâ", "success");
                    return;
                }

                Router.nav('study');
                this.nextCard();
            },

            nextCard() {
                if (this.queue.length === 0) {
                    Router.nav('decks');
                    UI.toast("To'plam yakunlandi! üèÜ", "success");
                    return;
                }

                this.currentCard = this.queue.shift(); // Kartani navbatdan olamiz
                this.isFlipped = false;
                this.renderUI();
            },

            getIntervalDisplay(rating) {
                const card = this.currentCard;
                let days = 0;
                
                if (rating === 1) days = 0.0035; // 5 min
                else if (rating === 2) days = 0.007; // 10 min
                else if (rating === 3) days = card.interval === 0 ? 1 : card.interval * card.ease;
                else if (rating === 4) days = card.interval === 0 ? 3 : card.interval * card.ease * 1.3;

                let intervalMs = days * 24 * 60 * 60 * 1000;
                let display = '';

                if (intervalMs < 60 * 60 * 1000) {
                    const mins = Math.round(intervalMs / (60 * 1000));
                    display = `${Math.max(1, mins)}m`;
                } else if (intervalMs < 24 * 60 * 60 * 1000) {
                    const hours = Math.round(intervalMs / (60 * 60 * 1000));
                    display = `${Math.max(1, hours)}s`;
                } else {
                    const dayCount = Math.round(intervalMs / (24 * 60 * 60 * 1000));
                    display = `${Math.max(1, dayCount)}k`;
                }
                return display;
            },

            renderUI() {
                const container = document.getElementById('study-container');
                const card = this.currentCard;

                if (!card) return; // Kartaning borligini tekshirish

                // Process Content
                let frontText = card.front;
                let backText = card.back;
                let hint = "";

                if (card.type === 'cloze') {
                    const regex = /{{c1::(.*?)}}/g;
                    frontText = card.front.replace(regex, '<span class="cloze-hidden" onclick="Study.flip(event)">???</span>');
                    backText = card.front.replace(regex, '<span class="cloze-revealed">$1</span>');
                    hint = "Bo'shliqni to'ldirish";
                }

                // Render Card HTML
                container.innerHTML = `
                    <!-- Top Bar -->
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="Router.nav('decks')" class="text-slate-400 hover:text-white active:scale-90 transition"><i class="fa-solid fa-xmark text-xl"></i></button>
                        <span class="text-xs font-bold text-brand-primary bg-blue-900/20 px-3 py-1 rounded-full">${this.queue.length + 1} ta qoldi</span>
                        <div class="w-6"></div>
                    </div>

                    <!-- Card Area -->
                    <div class="flex-1 perspective-1000 my-4 relative group cursor-pointer" onclick="Study.flip(event)">
                        <div id="active-card-inner" class="card-inner">
                            <!-- FRONT -->
                            <div class="card-front">
                                <div class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-6">${hint || 'Savol'}</div>
                                <div class="text-2xl md:text-3xl font-bold text-center leading-relaxed select-none">${frontText}</div>
                                <div class="absolute bottom-6 text-slate-500 text-xs animate-pulse">Javobni ko'rish uchun bosing</div>
                            </div>
                            <!-- BACK -->
                            <div class="card-back">
                                <div class="text-sm text-slate-500 line-through mb-4 opacity-50">${card.type === 'basic' ? frontText : ''}</div>
                                <div class="text-2xl md:text-3xl font-bold text-center text-white leading-relaxed select-none">${backText}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Controls -->
                    <div class="h-32 pt-4">
                        <button id="btn-show" onclick="Study.flip()" class="w-full h-16 bg-brand-primary hover:bg-blue-600 text-white text-lg font-bold rounded-2xl shadow-lg transition active:scale-[0.98]">
                            Javobni Ko'rsatish
                        </button>

                        <div id="btn-grading" class="hidden grid-cols-4 gap-2 h-24 animate-slide-up">
                            <!-- Ergonomik Tugmalar (Katta va Pastda) -->
                            <button onclick="Study.rate(1)" class="bg-slate-800 border-2 border-brand-error/50 text-brand-error rounded-2xl font-bold flex flex-col items-center justify-center text-sm active:scale-95 transition-all">
                                <span>Qayta</span> <span class="text-xs font-medium opacity-80">${this.getIntervalDisplay(1)}</span>
                            </button>
                            <button onclick="Study.rate(2)" class="bg-slate-800 border-2 border-brand-gold/50 text-brand-gold rounded-2xl font-bold flex flex-col items-center justify-center text-sm active:scale-95 transition-all">
                                <span>Qiyin</span> <span class="text-xs font-medium opacity-80">${this.getIntervalDisplay(2)}</span>
                            </button>
                            <button onclick="Study.rate(3)" class="bg-slate-800 border-2 border-brand-primary/50 text-brand-primary rounded-2xl font-bold flex flex-col items-center justify-center text-sm active:scale-95 transition-all">
                                <span>Yaxshi</span> <span class="text-xs font-medium opacity-80">${this.getIntervalDisplay(3)}</span>
                            </button>
                            <button onclick="Study.rate(4)" class="bg-slate-800 border-2 border-brand-accent/50 text-brand-accent rounded-2xl font-bold flex flex-col items-center justify-center text-sm active:scale-95 transition-all">
                                <span>Oson</span> <span class="text-xs font-medium opacity-80">${this.getIntervalDisplay(4)}</span>
                            </button>
                        </div>
                    </div>
                `;
            },

            flip(event) {
                // Cloze dagi alohida span bosilganda flip bo'lishini oldini olish
                if (event && event.target.classList.contains('cloze-hidden')) {
                    // Xatolikni tuzatish: Bu yerda hech narsa qilmaymiz, chunki foydalanuvchi javobni ko'rishni xohlaydi
                }
                
                if (this.isFlipped) return;
                this.isFlipped = true;
                document.getElementById('active-card-inner').classList.add('flipped');
                document.getElementById('btn-show').classList.add('hidden');
                document.getElementById('btn-grading').classList.remove('hidden');
                document.getElementById('btn-grading').classList.add('grid');
            },

            rate(rating) {
                // Update Card Logic
                const updatedCard = Algorithm.calculate(this.currentCard, rating);
                
                // Save to DB
                const idx = DB.data.cards.findIndex(c => c.id === updatedCard.id);
                if (idx > -1) DB.data.cards[idx] = updatedCard;
                
                // Update User Stats (Streak logic is in DB.checkStreak on load)
                DB.data.user.xp += (rating * 5);
                
                // Streakni yangilash
                const today = new Date().toDateString();
                if (DB.data.user.lastStudy !== today) {
                    DB.data.user.streak += 1;
                }
                DB.data.user.lastStudy = today;
                
                DB.save();
                
                // Motivatsiya Tizimini ishga tushirish (Har bir javobdan keyin)
                Motivation.show(); 
                
                // nextCard() Motivation.close() ichida chaqiriladi
            }
        };

        // --- 6. ACTIONS & UTILS (FIXED CARD ADDING) ---
        const UI = {
            currentType: 'basic',
            
            toggleType(type) {
                this.currentType = type;
                const b1 = document.getElementById('btn-basic');
                const b2 = document.getElementById('btn-cloze');
                const backBox = document.getElementById('back-box');
                const hint = document.getElementById('cloze-hint');

                if (type === 'basic') {
                    b1.classList.replace('text-slate-400', 'text-white');
                    b1.classList.add('bg-brand-primary');
                    b2.classList.remove('bg-brand-primary', 'text-white');
                    b2.classList.add('text-slate-400');
                    if (backBox) backBox.classList.remove('hidden');
                    if (hint) hint.classList.add('hidden');
                } else {
                    b2.classList.replace('text-slate-400', 'text-white');
                    b2.classList.add('bg-brand-primary');
                    b1.classList.remove('bg-brand-primary', 'text-white');
                    b1.classList.add('text-slate-400');
                    if (backBox) backBox.classList.add('hidden');
                    if (hint) hint.classList.remove('hidden');
                }
            },

            toast(msg, type='info') {
                const el = document.getElementById('toast');
                const icon = document.getElementById('toast-icon');
                document.getElementById('toast-msg').innerText = msg;

                el.classList.remove('opacity-0', 'translate-y-[-20px]');
                el.classList.add('animate-pop');

                if (type === 'success') {
                    icon.className = 'fa-solid fa-check-circle text-brand-accent';
                } else if (type === 'error') {
                    icon.className = 'fa-solid fa-triangle-exclamation text-brand-error';
                } else {
                    icon.className = 'fa-solid fa-info-circle text-brand-primary';
                }

                setTimeout(() => {
                    el.classList.remove('animate-pop');
                    el.classList.add('opacity-0', 'translate-y-[-20px]');
                }, 2500);
            }
        };

        const Actions = {
            addDeck() {
                const nameInput = document.getElementById('inp-deck-name');
                const name = nameInput.value.trim();
                if (!name) return UI.toast("To'plam nomini kiriting!", "error");
                
                DB.data.decks.push({
                    id: 'd' + Date.now(),
                    name: name,
                    icon: 'fa-book',
                    color: 'from-slate-600 to-slate-800'
                });
                DB.save();
                nameInput.value = ''; // Inputni tozalash
                Router.nav('add'); // Qayta yuklash (select box yangilanishi uchun)
                UI.toast("To'plam yaratildi", "success");
            },

            addCard() {
                const deckId = document.getElementById('inp-deck')?.value;
                const frontInput = document.getElementById('inp-front');
                const backInput = document.getElementById('inp-back');

                const front = frontInput.value.trim();
                const back = backInput.value.trim();
                const type = UI.currentType;

                if (!front) return UI.toast("Savol yozilmadi!", "error");
                if (!deckId) return UI.toast("To'plam tanlanmadi!", "error");
                
                if (type === 'basic' && !back) return UI.toast("Javob yozilmadi!", "error");
                if (type === 'cloze' && !front.includes('{{c1::')) return UI.toast("Cloze format xato! {{c1::so'z}} ishlating.", "error");

                DB.data.cards.push({
                    id: 'c' + Date.now(),
                    deckId,
                    front, 
                    back: type === 'cloze' ? '' : back,
                    type,
                    nextReview: Date.now(),
                    interval: 0,
                    ease: 2.5
                });
                DB.save();
                
                // Inputlarni tozalash
                frontInput.value = '';
                if (backInput) backInput.value = '';
                
                UI.toast("Karta muvaffaqiyatli saqlandi", "success");
            },

            reset() {
                // Custom modal o'rniga, vaqtincha console bilan ishlaymiz
                if(confirm("Hamma ma'lumotlarni o'chirishga aminmisiz? Bu qaytarilmaydi!")) {
                    localStorage.removeItem(DB.key);
                    location.reload();
                }
            }
        };

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            DB.init();
            Router.nav('decks');
        });

    </script>
</body>
</html>

